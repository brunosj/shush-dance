name: Deploy SHUSH

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          mkdir -p ~/.ssh/
          echo "${SSH_PRIVATE_KEY}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

      - name: Execute deployment script
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          set -e
          echo "üöÄ Starting SHUSH deployment..."
          ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOST }} "
            set -e
            echo 'üìÇ Checking repo directory...'
            if [ ! -d '/home/lando/repo' ]; then
              echo '‚ùå Repo directory not found!'
              exit 1
            fi
            
            echo 'üì• Fetching latest changes first...'
            cd /home/lando/repo
            git fetch origin
            git reset --hard origin/main
            
            echo 'üìã Checking updated deploy script...'
            if [ ! -f 'scripts/deploy.sh' ]; then
              echo '‚ùå Deploy script not found in scripts folder!'
              exit 1
            fi
            
            echo 'üöÄ Executing updated deployment script...'
            bash scripts/deploy.sh
          "
          EXIT_STATUS=$?
          if [ $EXIT_STATUS -eq 0 ]; then
            echo "‚úÖ Deployment completed successfully"
          else
            echo "‚ùå Deployment failed with exit status $EXIT_STATUS"
          fi
          exit $EXIT_STATUS

      - name: Verify deployment
        if: success()
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "üîç Verifying deployment status..."
          ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOST }} '
            set -e
            export PATH=$HOME/.nvm/versions/node/v22.20.0/bin:$HOME/.local/share/pnpm:$PATH
            
            echo "üìä PM2 Process Status:"
            pm2 list
            echo ""
            
            echo "üîó Blue-Green Deployment Status:"
            ACTIVE_LINK=$(readlink /home/lando/app/active 2>/dev/null)
            if [ -n "$ACTIVE_LINK" ]; then
              ACTIVE_COLOR=$(echo "$ACTIVE_LINK" | grep -o "blue\|green")
              echo "Active deployment: $ACTIVE_COLOR"
              echo "Active symlink: $ACTIVE_LINK"
              
              # Determine active port
              if [ "$ACTIVE_COLOR" = "blue" ]; then
                ACTIVE_PORT=3000
              else
                ACTIVE_PORT=3001
              fi
            else
              echo "‚ö†Ô∏è  No active symlink found, trying both ports"
              ACTIVE_PORT=3000
            fi
            echo ""
            
            echo "üè• Health Check (port $ACTIVE_PORT):"
            HEALTH=$(curl -sf http://localhost:$ACTIVE_PORT/api/health)
            if [ -z "$HEALTH" ]; then
              echo "‚ùå Application not responding on port $ACTIVE_PORT"
              echo ""
              echo "Trying alternate port..."
              HEALTH=$(curl -sf http://localhost:3001/api/health 2>/dev/null || curl -sf http://localhost:3000/api/health 2>/dev/null)
              if [ -z "$HEALTH" ]; then
                echo "‚ùå Application not responding on any port"
                exit 1
              fi
            fi
            echo "$HEALTH"
            echo "‚úÖ Application OK"
            echo ""
            
            echo "üìÅ Directory Structure:"
            ls -la /home/lando/app/
          '

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Notify via Resend
        uses: brunosj/actions/resend-notify@v1
        with:
          subject: 'GitHub Actions - Deploy SHUSH Failed'
          resend_api_key: ${{ secrets.RESEND_API_KEY }}
